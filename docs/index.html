<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kyphi Index — alias-aware</title>
  <style>
    :root{
      --headerOffset: 0px;
      --bg:#0f1115; --card:#171923; --muted:#8b93a7; --fg:#e6e9f2; --accent:#6ea8ff; --pill:#283048;
      --ok:#7bd88f; --warn:#ffd479; --border:#24283b; --rowA:#10131a; --rowB:#0e1016; --link:#a0a6b9;
      font-synthesis-weight:none; text-rendering:optimizeLegibility;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb; --card:#ffffff; --muted:#5b6478; --fg:#0b0d12; --accent:#0b57d0; --pill:#e8eefc;
      --ok:#1e8e3e; --warn:#b06e00; --border:#e6e8f0; --rowA:#ffffff; --rowB:#fafbff; --link:#4a5370;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--accent)}
    .wrap{white-space:normal; word-break:break-word}
    header{position:sticky;top:0;background:linear-gradient(180deg, color-mix(in oklab,var(--bg) 96%, transparent), color-mix(in oklab,var(--bg) 92%, transparent));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border);z-index:5}
    .container{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .controls input[type="text"]{flex:1 1 260px;padding:9px 10px;border-radius:8px;border:1px solid var(--border);background:color-mix(in oklab, var(--bg) 90%, #0000);color:var(--fg)}
    .switch, .btn{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .btn{border:1px solid var(--border);border-radius:10px;padding:6px 10px;cursor:pointer;user-select:none;background:var(--card);}
    .btn:hover{filter:brightness(1.05)}
    .btn-group{display:flex;gap:6px;flex-wrap:wrap}
    .chip-list{display:flex;gap:8px;flex-wrap:wrap;max-height:86px;overflow:auto;padding:8px;border:1px dashed var(--border);border-radius:10px;background:color-mix(in oklab, var(--card) 92%, transparent)}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--card);}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;background:var(--pill);color:color-mix(in oklab,var(--accent) 80%, var(--fg));margin-left:6px;font-size:12px}
    .note{display:inline-block;margin-left:6px;color:var(--muted)}
    .best-guess{border-left:3px solid var(--accent);padding-left:8px}
    .muted{color:var(--muted)}
    .small{font-size:12px}

    /* Table: single scroll context (page), sticky header + first column */
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    thead th{
      position:sticky;top:var(--headerOffset);
      background:var(--card);
      z-index:6;
      border-bottom:2px solid var(--border);
      box-shadow:0 1px 0 var(--border);
    }
    thead th:first-child{z-index:7}
    th,td{vertical-align:top;border-bottom:1px solid var(--border);padding:10px 12px;overflow:hidden;text-overflow:ellipsis}
    th:first-child, td:first-child{
      position:sticky;left:0;background:var(--card);z-index:5;box-shadow:1px 0 0 var(--border)
    }
    tbody tr:nth-child(odd) td{background:var(--rowA)}
    tbody tr:nth-child(even) td{background:var(--rowB)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .stat{color:var(--muted)}
    footer{color:var(--muted);text-align:center;padding:22px}
    .linked-ingredient{color:var(--link)}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row" style="align-items:center; justify-content:space-between">
        <h1>Kyphi Ingredient Index</h1>
        <div class="row" style="align-items:center;gap:10px">
          <div class="stat"><span id="countShown">0</span> shown • <span id="countTotal">0</span> total</div>
          <button id="toggleTheme" class="btn" title="Toggle day/night">Toggle theme</button>
        </div>
      </div>
      <div class="controls">
        <input id="q" type="text" placeholder="Search ingredients, aliases (e.g., ‘myrrh’), notes, amounts…" />
        <label class="switch"><input id="toggleSmart" type="checkbox" /> Smart alignment</label>
        <label class="switch"><input id="toggleAmt" type="checkbox" checked /> Amounts</label>
        <label class="switch"><input id="togglePrep" type="checkbox" checked /> Preparation</label>
        <label class="switch"><input id="toggleNotes" type="checkbox" /> Notes</label>
        <label class="switch"><input id="toggleShowAliases" type="checkbox" checked /> Show aliases under name</label>
      </div>
      <div class="row" style="align-items:flex-start; gap:12px; margin-top:10px">
        <div class="btn-group">
          <button id="btnAll" class="btn">Select all</button>
          <button id="btnNone" class="btn">Select none</button>
          <button id="btnExportCSV" class="btn">Export CSV</button>
          <button id="btnExportJSON" class="btn">Export JSON</button>
        </div>
      </div>
      <div class="chip-list" id="recipeChips" aria-label="Recipes"></div>
    </div>
  </header>

  <main class="container" style="margin-top:10px">
    <div class="card">
      <table id="grid">
        <thead><tr><th>Ingredient</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>
    Data: kyphi_long.json • equivalences.json
  </footer>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const nfkc = s => (s==null?"":String(s)).normalize("NFKC");

  // Elements
  const qInput = $('#q');
  const toggleSmart = $('#toggleSmart');
  const toggleAmt = $('#toggleAmt');
  const togglePrep = $('#togglePrep');
  const toggleNotes = $('#toggleNotes');
  const toggleShowAliases = $('#toggleShowAliases');
  const toggleThemeBtn = $('#toggleTheme');
  const thead = document.querySelector('#grid thead');
  const tbody = document.querySelector('#grid tbody');
  const countShown = $('#countShown');
  const countTotal = $('#countTotal');
  const recipeChips = $('#recipeChips');

  // State
  let rows = [];              // flattened entries from kyphi_long
  let allRecipes = [];        // master list
  let selectedRecipes = new Set();
  let equivalences = {};      // alignment map
  let searchIndex = [];       // [{row: <tr>, text: lowercased searchable blob}]
  let filteredCount = 0;

  // Sample fallback data
  const sampleRows = [
    { recipe:"Sample Rufus", ingredient:"σμύρνη", amount:"12", preparation:"ground", notes:"=myrrh", aliases:["myrrh"] },
    { recipe:"Sample Rufus", ingredient:"μέλι", amount:"24", preparation:"", notes:"honey", aliases:["honey"] },
    { recipe:"Sample Diosc.", ingredient:"σμύρνη", amount:"", preparation:"", notes:"alt source", aliases:["myrrh"] }
  ];
  const sampleEquivalences = { "Myrrh":["σμύρνη","smyrna","smyrne"] };

  // Load data
  Promise.all([
    fetch('kyphi_long.json').then(r=>r.json()),
    fetch('equivalences.json').then(r=>r.json()).catch(()=>({}))
  ]).then(([longRows, eq])=>{
    initWithData(longRows, eq);
  }).catch(err=>{
    console.warn('Falling back to sample data due to load error:', err);
    initWithData(sampleRows, sampleEquivalences);
  });

  function initWithData(longRows, eq){
    const validRows = longRows.filter(r => r && r.ingredient && r.recipe);
    rows = validRows.map(r => ({
      recipe: nfkc(r.recipe),
      ingredient: nfkc(r.ingredient),
      amount: r.amount ?? r.amount_raw ?? null,
      preparation: r.preparation ?? null,
      notes: r.notes ?? null,
      aliases: normaliseAliases(r.aliases)
    }));

    allRecipes = Array.from(new Set(rows.map(r=>r.recipe)));
    selectedRecipes = new Set(allRecipes);

    equivalences = coerceEquivalences(eq);
    toggleSmart.checked = Object.keys(equivalences).length > 0;

    renderRecipeChips();
    render();
    attachEvents();
    setHeaderOffset();
    window.addEventListener('resize', setHeaderOffset);
  }

  function setHeaderOffset(){
    const h = document.querySelector('header');
    const top = (h?.offsetHeight || 0) + 'px';
    document.documentElement.style.setProperty('--headerOffset', top);
  }

  function normaliseAliases(a){
    if (!a) return [];
    if (Array.isArray(a)) return a.map(s=>nfkc(s).trim()).filter(Boolean);
    return String(a).split(',').map(s=>nfkc(s).trim()).filter(Boolean);
  }

  function coerceEquivalences(eq){
    if (!eq) return {};
    if (Array.isArray(eq)){
      const out = {};
      eq.forEach(e=>{
        if(!e) return;
        const key = nfkc(e.aligned || e.key || e.name || '').trim();
        const vars = (e.variants || e.values || []).map(v=>nfkc(v).trim()).filter(Boolean);
        if (key) out[key] = Array.from(new Set([key, ...vars]));
      });
      return out;
    }
    if (typeof eq === 'object'){
      const out = {};
      for (const k in eq){
        const key = nfkc(k).trim();
        const vals = Array.isArray(eq[k]) ? eq[k] : (eq[k]?.variants || []);
        out[key] = Array.from(new Set([key, ...vals.map(v=>nfkc(v).trim())]));
      }
      return out;
    }
    return {};
  }

  function attachEvents(){
    qInput.addEventListener('input', liveFilter);
    toggleSmart.addEventListener('change', render);
    toggleAmt.addEventListener('change', render);
    togglePrep.addEventListener('change', render);
    toggleNotes.addEventListener('change', render);
    toggleShowAliases.addEventListener('change', render);

    $('#btnAll').addEventListener('click', ()=>{ selectedRecipes = new Set(allRecipes); updateChipChecks(true); render();});
    $('#btnNone').addEventListener('click', ()=>{ selectedRecipes = new Set(); updateChipChecks(false); render();});

    $('#btnExportCSV').addEventListener('click', ()=> exportData('csv'));
    $('#btnExportJSON').addEventListener('click', ()=> exportData('json'));

    toggleThemeBtn.addEventListener('click', ()=>{
      const html = document.documentElement;
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
    });
  }

  function renderRecipeChips(){
    recipeChips.innerHTML = '';
    allRecipes.forEach(rec => {
      const id = 'rec_' + rec.replace(/[^a-z0-9]+/gi,'_');
      const chip = document.createElement('label');
      chip.className = 'chip';
      chip.innerHTML = `<input type="checkbox" id="${id}" ${selectedRecipes.has(rec)?'checked':''}/> <span>${escapeHTML(rec)}</span>`;
      chip.querySelector('input').addEventListener('change', (e)=>{
        if (e.target.checked) selectedRecipes.add(rec); else selectedRecipes.delete(rec);
        render();
      });
      recipeChips.appendChild(chip);
    });
  }

  function updateChipChecks(val){
    recipeChips.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked = val; });
  }

  function render(){
    const smartAlignment = !!toggleSmart.checked && Object.keys(equivalences).length>0;
    const show = { amounts: toggleAmt.checked, prep: togglePrep.checked, notes: toggleNotes.checked };

    const activeRecipes = allRecipes.filter(r => selectedRecipes.has(r));

    // Build aligned ingredient list from rows filtered by selected recipes
    const filteredRowsByRecipe = rows.filter(r => selectedRecipes.has(r.recipe));
    const rawIngredients = Array.from(new Set(filteredRowsByRecipe.map(r=>r.ingredient)));
    const alignedIngredients = getAlignedIngredients(rawIngredients, smartAlignment);

    // header
    thead.innerHTML = `<tr><th>Ingredient${smartAlignment ? ' (Aligned)' : ''}</th>${activeRecipes.map(r=>`<th>${escapeHTML(r)}</th>`).join('')}</tr>`;

    // reset
    tbody.innerHTML = '';
    searchIndex = [];
    filteredCount = 0;

    const query = nfkc(qInput.value || '').toLowerCase().trim();

    alignedIngredients.forEach(alignedIng => {
      const tr = document.createElement('tr');

      // Ingredient cell
      let ingredientDisplay = '';
      if (alignedIng.group){
        ingredientDisplay = `<div class="wrap best-guess">
          <strong>${escapeHTML(alignedIng.aligned)}</strong><br>
          <small class="linked-ingredient">${escapeHTML(alignedIng.variants.join(', '))}</small>
        </div>`;
      } else {
        ingredientDisplay = `<div class="wrap"><strong>${escapeHTML(alignedIng.aligned)}</strong></div>`;
      }

      // Optional: show aliases merged from all matching rows under the name
      const relevantIngredients = alignedIng.group ? alignedIng.variants : [alignedIng.original];
      const aliasTokens = Array.from(new Set(
        rows
          .filter(r => selectedRecipes.has(r.recipe) && relevantIngredients.includes(r.ingredient))
          .flatMap(r => r.aliases)
          .map(s => s.toLowerCase())
      ));
      if (toggleShowAliases.checked && aliasTokens.length){
        ingredientDisplay += `<div class="muted small">aliases: ${escapeHTML(aliasTokens.join(', '))}</div>`;
      }

      tr.innerHTML = `<td>${ingredientDisplay}</td>`;

      // Recipe columns
      activeRecipes.forEach(rec => {
        const matches = rows.filter(r => selectedRecipes.has(r.recipe) && relevantIngredients.includes(r.ingredient) && r.recipe === rec);
        if (!matches.length){
          tr.innerHTML += `<td>—</td>`;
          return;
        }
        const cell = matches.map(m => {
          const bits = [`<strong>${escapeHTML(m.ingredient)}</strong>`];
          if (show.amounts && m.amount) bits.push(`<span class="pill">${escapeHTML(m.amount)}</span>`);
          if (show.prep && m.preparation) bits.push(`<span class="pill">${escapeHTML(m.preparation)}</span>`);
          if (show.notes && m.notes) bits.push(`<span class="note">${escapeHTML(m.notes)}</span>`);
          return bits.join(' ');
        }).join('<br>');
        tr.innerHTML += `<td>${cell}</td>`;
      });

      // Build searchable text including aliases
      const textBlob = (
        nfkc(alignedIng.aligned) + ' ' +
        nfkc(tr.textContent) + ' ' +
        aliasTokens.join(' ')
      ).toLowerCase();

      // Filter visibility
      const matchesSearch = !query || textBlob.includes(query);
      tr.style.display = matchesSearch ? '' : 'none';
      if (matchesSearch) filteredCount++;

      tbody.appendChild(tr);
      searchIndex.push({ row: tr, text: textBlob });
    });

    countTotal.textContent = String(alignedIngredients.length);
    countShown.textContent = String(filteredCount);
  }

  function liveFilter(){
    const q = nfkc(qInput.value || '').toLowerCase().trim();
    filteredCount = 0;
    searchIndex.forEach(({row, text}) => {
      const visible = !q || text.includes(q);
      row.style.display = visible ? '' : 'none';
      if (visible) filteredCount++;
    });
    countShown.textContent = String(filteredCount);
  }

  // Export current view (respecting selected recipes and search query)
  function exportData(kind){
    const q = nfkc(qInput.value || '').toLowerCase().trim();
    const inSelectedRecipes = r => selectedRecipes.has(r.recipe);
    const rowBlob = r => [r.ingredient, r.amount||'', r.preparation||'', r.notes||'', (r.aliases||[]).join(' '), r.recipe].join(' ').toLowerCase();
    const filtered = rows.filter(r => inSelectedRecipes(r) && (!q || rowBlob(r).includes(q)));

    if (kind === 'json'){
      const data = JSON.stringify(filtered, null, 2);
      downloadFile('kyphi_filtered.json', data, 'application/json');
      return;
    }
    // csv
    const header = ['recipe','ingredient','amount','preparation','notes','aliases'];
    const lines = [header.join(',')].concat(filtered.map(r => [
      csvEsc(r.recipe), csvEsc(r.ingredient), csvEsc(r.amount||''), csvEsc(r.preparation||''), csvEsc(r.notes||''), csvEsc((r.aliases||[]).join('; '))
    ].join(',')));
    downloadFile('kyphi_filtered.csv', lines.join('\n'), 'text/csv');
  }

  function csvEsc(v){
    const s = String(v).replaceAll('"', '""');
    return /[",\n]/.test(s) ? '"'+s+'"' : s;
  }

  function downloadFile(filename, data, type){
    const blob = new Blob([data], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  // Grouping/alignment helper
  function getAlignedIngredients(rawList, smart){
    if (!smart){
      return rawList.map(name => ({ aligned: name, original: name, group: false }));
    }
    const used = new Set();
    const res = [];

    // Create variant -> aligned map
    const variantToAligned = new Map();
    for (const aligned in equivalences){
      const variants = equivalences[aligned] || [];
      const canonAligned = nfkc(aligned);
      variants.concat([aligned]).forEach(v => variantToAligned.set(nfkc(v), canonAligned));
    }

    for (const name of rawList){
      if (used.has(name)) continue;
      const aligned = variantToAligned.get(name) || name;

      // collect all variants present in dataset that map to same aligned
      const variantsHere = rawList.filter(n => (variantToAligned.get(n)||n) === aligned);
      variantsHere.forEach(v=>used.add(v));

      if (variantsHere.length > 1 || aligned !== variantsHere[0]){
        res.push({ aligned, variants: variantsHere, original: variantsHere[0], group: true });
      } else {
        res.push({ aligned: name, original: name, group: false });
      }
    }
    // sort alphabetically by aligned
    res.sort((a,b)=>a.aligned.localeCompare(b.aligned));
    return res;
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }
})();
</script>
</body>
</html>